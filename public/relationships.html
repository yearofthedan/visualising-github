<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Relationships</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsonpath@1.0.2/jsonpath.min.js"></script>
</head>
<body>
<nav><a href="/">Home</a></nav>
<article>
  Organisation to query <input id="organisation" type="text" value="facebook"/>
  <button id="run-org-query" type="button">Query entire org</button>
  Repo to query <input id="repo" type="text" value="react"/>
  <button id="run-repo-query" type="button">Query org and repo</button>

  <script type="module">
    import {draw} from "./chart.js";
    import {doQuery} from "./graphQLQuery.js";
    import orgReviewApprovalNetwork from "./queries/orgReviewApprovalNetwork.js";
    import repoReviewApprovalNetwork from "./queries/repoReviewApprovalNetwork.js";

    document.getElementById("run-org-query").addEventListener('click', generateOrgReviewChart);
    document.getElementById("run-repo-query").addEventListener('click', generateRepoReviewChart);

    async function generateRepoReviewChart() {
      const organisation = document.getElementById("organisation").value;
      const repo = document.getElementById("repo").value;

      const repoData = (await doQuery(repoReviewApprovalNetwork(organisation, repo))).repository;
      const buildingChartData = {
        nodes: new Set(),
        links: new Map(),
      }

      const deriveKey = (str1, str2) => {
        return str1 < str2 ? `${str1}${str2}` : `${str2}${str1}`
      }

      repoData.pullRequests.nodes
      .forEach(pr => {
        pr.reviews.nodes.forEach(review => {
          buildingChartData.nodes.add(review.author.login)
          buildingChartData.nodes.add(pr.author.login)

          const key = deriveKey(review.author.login, pr.author.login);

          if (buildingChartData.links.has(key)) {
            const current = buildingChartData.links.get(key);

            buildingChartData.links.set(key, {
              ...current,
              value: current.value + 1
            })
          } else {
            buildingChartData.links.set(key, {
              source: review.author.login,
              target: pr.author.login,
              value: 1
            })
          }
        })
      });

      draw({
        nodes: Array.from(buildingChartData.nodes).map(name => ({id: name})),
        links: Array.from(buildingChartData.links.values())
      })
    }


    async function generateOrgReviewChart() {
      const organisation = document.getElementById("organisation").value;
      const orgData = (await doQuery(orgReviewApprovalNetwork(organisation))).repositoryOwner.repositories.nodes;

      const buildingChartData = {
        nodes: new Set(),
        links: new Map(),
      }

      const deriveKey = (str1, str2) => {
        return str1 < str2 ? `${str1}${str2}` : `${str2}${str1}`
      }

      orgData.forEach((repo) => {
        repo.pullRequests.nodes
        .forEach(pr => {
          pr.reviews.nodes.forEach(review => {
            buildingChartData.nodes.add(review.author.login)
            buildingChartData.nodes.add(pr.author.login)

            const key = deriveKey(review.author.login, pr.author.login);

            if (buildingChartData.links.has(key)) {
              const current = buildingChartData.links.get(key);

              buildingChartData.links.set(key, {
                ...current,
                value: current.value + 1
              })
            } else {
              buildingChartData.links.set(key, {
                source: review.author.login,
                target: pr.author.login,
                value: 1
              })
            }
          })
        });
      });

      draw({
        nodes: Array.from(buildingChartData.nodes).map(name => ({id: name})),
        links: Array.from(buildingChartData.links.values())
      })
    }
  </script>
</article>
</body>
</html>
